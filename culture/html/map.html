<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />

  <title>Mapx Era</title>

  <style>
    /* Fix Leaflet zoom buttons on top-right */
    .leaflet-control-zoom {
      right: 1rem !important;
      top: 5rem !important;
      left: auto !important;
      background: rgba(0,0,0,0.5);
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 4px 20px rgba(0,0,0,0.5);
    }

    .leaflet-control-zoom a {
      background: transparent !important;
      color: white !important;
      font-size: 20px !important;
      width: 36px !important;
      height: 36px !important;
      line-height: 36px !important;
      text-align: center;
    }
  </style>
</head>
<body class="h-screen w-screen relative bg-gray-900 font-sans">

  <!-- Map Container -->
  <div id="map" class="h-screen w-full"></div>

  <!-- Back Button -->
  <a href="home.html"
     class="fixed bottom-5 left-5 z-[1000]
            flex items-center gap-2
            px-5 py-2.5
            text-sm font-medium text-white
            rounded-full
            bg-black/60 backdrop-blur-md
            border border-white/30
            shadow-lg
            transition-all duration-300
            hover:bg-gradient-to-r hover:from-orange-400 hover:to-yellow-400
            hover:text-black hover:-translate-x-1">
    â¬… Back
  </a>

  <!-- Search Box (Fixed) -->
  <div class="fixed top-5 left-5 z-[1000]">
    <div
      class="bg-black/60 backdrop-blur-lg
             border border-white/20
             rounded-2xl px-4 py-2
             shadow-xl
             transition hover:border-white/40">
      <input
        type="text"
        id="searchBox"
        placeholder="Search a place..."
        oninput="debouncedSearch()"
        class="bg-transparent outline-none
               text-white placeholder-white/60
               text-sm w-56 md:w-60"
      />
    </div>
  </div>

  <!-- Layer Buttons (Fixed) -->
  <div class="fixed top-20 right-5 z-[1000]
              flex flex-col gap-3
              p-4 rounded-2xl
              bg-black/60 backdrop-blur-lg
              border border-white/20
              shadow-2xl">
    <button onclick="setLayer('satellite')"
            class="px-4 py-2 text-sm text-white
                   rounded-xl
                   bg-gradient-to-r from-green-400 to-emerald-500
                   hover:-translate-y-1 transition">
      Satellite
    </button>
    <button onclick="setLayer('topo')"
            class="px-4 py-2 text-sm text-white
                   rounded-xl
                   bg-gradient-to-r from-green-400 to-emerald-500
                   hover:-translate-y-1 transition">
      Topographic
    </button>
    <button onclick="setLayer('dark')"
            class="px-4 py-2 text-sm text-white
                   rounded-xl
                   bg-gradient-to-r from-green-400 to-emerald-500
                   hover:-translate-y-1 transition">
      Dark
    </button>
  </div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    // Initialize Map
    const map = L.map("map", {
      zoomControl: true
    }).setView([22.9734, 78.6569], 5);

    // Tile Layers
    const tileLayers = {
      default: L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png"),
      satellite: L.tileLayer("https://{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}", {
        subdomains: ["mt0", "mt1", "mt2", "mt3"],
      }),
      topo: L.tileLayer("https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png"),
      dark: L.tileLayer("https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png")
    };

    tileLayers.dark.addTo(map);

    function setLayer(name) {
      map.eachLayer(layer => map.removeLayer(layer));
      tileLayers[name].addTo(map);
    }

    // Debounced Search
    let searchTimeout = null;
    function debouncedSearch() {
      clearTimeout(searchTimeout);
      searchTimeout = setTimeout(() => {
        const query = document.getElementById("searchBox").value;
        if (query.length < 3) return;
        searchPlace(query);
      }, 500);
    }

    function searchPlace(query) {
      fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}`)
        .then(res => res.json())
        .then(data => {
          if (!data.length) return;
          const result = data[0];
          const lat = parseFloat(result.lat);
          const lon = parseFloat(result.lon);

          map.setView([lat, lon], 14);
          L.marker([lat, lon]).addTo(map).bindPopup(query).openPopup();
          showNearbyPOIs(lat, lon);
        })
        .catch(error => console.error("Search error:", error));
    }

    function showNearbyPOIs(lat, lng) {
      const radius = 70;
      const query = `
        [out:json][timeout:25];
        (
          node["amenity"~"school|hospital|restaurant|cafe|bank|police|university|pharmacy"](around:${radius},${lat},${lng});
          way["amenity"~"school|hospital|restaurant|cafe|bank|police|university|pharmacy"](around:${radius},${lat},${lng});
          relation["amenity"~"school|hospital|restaurant|cafe|bank|police|university|pharmacy"](around:${radius},${lat},${lng});
        );
        out center;
      `;

      fetch("https://overpass-api.de/api/interpreter", { method: "POST", body: query })
        .then(res => res.json())
        .then(data => {
          if (!data.elements.length) return;
          data.elements.forEach(el => {
            const latLng = el.type === "node" ? [el.lat, el.lon] : [el.center?.lat, el.center?.lon];
            if (latLng[0] && latLng[1]) {
              const name = el.tags.name || el.tags.amenity || "POI";
              L.marker(latLng).addTo(map).bindPopup(name);
            }
          });
        })
        .catch(error => console.error("POI fetch error:", error));
    }
  </script>
</body>
</html>
